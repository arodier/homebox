<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="André Rodier">
  
  <title>Backup restoration - homebox installation</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../css/extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Backup restoration";
    var mkdocs_page_input_path = "backup-restore.md";
    var mkdocs_page_url = "/backup-restore/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> homebox installation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../features/">Features</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../prerequisites/">Before the installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../preseed/">Debian OS installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../installation/">Homebox Installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../email-configuration/">Email configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../webmail-roundcube/">Roundcube Webmail</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../groupware-sogo/">Sogo Groupware</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../email-access-monitoring/">Email access monitoring</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../antispam-rspamd/">Antispam configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../jabber-configuration/">Jabber configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../gogs-configuration/">Gogs configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../tor-privoxy-configuration/">Tor / privoxy configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../firewall-configuration/">Firewall configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../security-configuration/">Security configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../transmission-configuration/">Transmission configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../bind-configuration/">DNS Server configuration</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../external-accounts/">External accounts</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../backup-home/">Backup your home folders</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Backup restoration</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#partial-restoration">Partial restoration</a></li>
                
            
                <li class="toctree-l3"><a href="#data-restoration">Data restoration</a></li>
                
            
                <li class="toctree-l3"><a href="#complete-restoration">Complete restoration</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../deployment-backup/">Backup your deployment</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../backup-server/">Backup server</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../zabbix/">Monitoring with Zabbix</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../maintenance/">Maintenance</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../development/">Testing and development</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../codeofconduct/">Code of conduct</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">homebox installation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Backup restoration</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/progmaticltd/homebox/" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="partial-restoration">Partial restoration</h1>
<p>This is necessary if you lost a specific email, or if you want to go back in time, and restore a bunch of emails you
inadvertently deleted.</p>
<p>At this time, the partial restoration is manual and can be done only by root. An easier option to retrieve emails from
backups will be provided in a future version. In the mean time, the process has to be manual:</p>
<ol>
<li>Connect on the server, using SSH, as root.</li>
<li>Load the backup encryption key into your environment.</li>
<li>List the backups snapshots, using <a href="https://borgbackup.readthedocs.io/en/stable/usage/list.html">borg list command</a></li>
<li>Mount the backup snapshot you are interested in, they are listed by date.
   You can do this by using the <a href="https://borgbackup.readthedocs.io/en/stable/usage/mount.html">borg mount command</a></li>
<li>Search in the mounted drive for the lost emails, using for instance the excellent midnight commander.</li>
<li>Copy the emails at the place of your choice, perhaps in your /home/users/<user>/mails/maildir/ folder to make them
   accessible from an email client.</li>
<li>Make sure the copied email files belongs to the right user, otherwise Dovecot won&rsquo;t be able to read these files.
   belongs to the right user.</li>
<li>The last thing to do, before disconnecting, is to ‘unmount’ the backup snapshot, using the
   <a href="https://borgbackup.readthedocs.io/en/stable/usage/mount.html#borg-umount">borg umount command</a></li>
<li>Finally, disconnect from SSH.</li>
<li>Open your email client.</li>
</ol>
<h1 id="data-restoration">Data restoration</h1>
<p>Something bad happened, for instance you just deleted a lot of email, contacts or calendar events. In this case, before
the next backup occurs and backup your mistake, you can quickly restore your emails, calendar events and contacts, with
just one line.</p>
<p>So, just run the main borgbackup installation script:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> install
ansible-playbook -v -i ../config/hosts.yml -t restore playbooks/borgbackup.yml
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This step restores all the emails from the last backup. It does not restore your emails from a &ldquo;previous&rdquo;
state. Therefore, it does not delete any emails that have been created <em>after</em> the backup. The same is happening for
calendar events and contacts.</p>
</div>
<h1 id="complete-restoration">Complete restoration</h1>
<p>This is the disaster recovery option.</p>
<p>Something really bad happened, and you lost your box. Don&rsquo;t panic, if you have installed the system properly, you can
easily restore it from scratch, with the all your users&rsquo; data. This is done by adding one line in your sysetm.yml file!</p>
<p>The important thing is to have kept the <a href="../deployment-backup/">deployment backup folder</a> in a safe place, for instance
on an encrypted USB drive.</p>
<p>Let&rsquo;s say you have used Amazon S3 for the daily backup of your system. So, open your system.yml file with your favourite
editor, and add the line <code>restore: true</code> to the backup location you want to restore from. For instance:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">backup</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">install</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">alerts</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="s">&#39;postmaster@casimir.fx&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">recipient</span><span class="p p-Indicator">:</span> <span class="s">&#39;hendrick@universiteitleiden.nl&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">jabber</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">locations</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s3main</span>
<span class="hll">    <span class="l l-Scalar l-Scalar-Plain">restore</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</span>    <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s3fs://mnt/backup/s3main/casimir.fx</span>
    <span class="l l-Scalar l-Scalar-Plain">active</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="l l-Scalar l-Scalar-Plain">frequency</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">daily</span>
    <span class="l l-Scalar l-Scalar-Plain">keep_daily</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
    <span class="l l-Scalar l-Scalar-Plain">keep_weekly</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
    <span class="l l-Scalar l-Scalar-Plain">keep_monthly</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
    <span class="l l-Scalar l-Scalar-Plain">access_key_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AKIAM2HEGKRL50SDZTTC</span>
    <span class="l l-Scalar l-Scalar-Plain">secret_access_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">MpHag/11PUXRVIDSKMV8YQZZDW95IGDV</span>
    <span class="l l-Scalar l-Scalar-Plain">bucket_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">casimir.fx</span>
    <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">eu-west-2</span>
    <span class="l l-Scalar l-Scalar-Plain">check_frequency</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">weekly</span>
</pre></div>


<p>Now, run the main installation script, to completely reinstall the system. For instance:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> install
ansible-playbook -v -i ../config/hosts.yml playbooks/main.yml
</pre></div>


<p>Depending on the amount of data, the network speed and computer power, the whole installation is taking enough time for
you to have a well deserved break. Prepare yourself a nice cup of tea or coffee. Once installed, you should have all
your emails from the last backup restored.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can perfectly restore from multiple location, by adding the line <code>restore: true</code> to each backup location. In
this case, the data will be merged, so you won&rsquo;t have duplicate emails, calendar events or contacts.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example, an email and a Jabber message are sent after the system has been restored.</p>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../deployment-backup/" class="btn btn-neutral float-right" title="Backup your deployment">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../backup-home/" class="btn btn-neutral" title="Backup your home folders"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Creative Commons Attribution-ShareAlike 4.0 International License</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/progmaticltd/homebox/" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../backup-home/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../deployment-backup/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>

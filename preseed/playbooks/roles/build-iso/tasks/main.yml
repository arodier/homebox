---

- name: 'Create the working directory in {{ build_dir }}'
  tags: preseed
  file:
    path: '{{ build_dir }}'
    state: directory

- name: Prepare additional kernel parameters
  set_fact:
    kernel_params: >-
      locale={{ locale.id }}.{{ locale.charset }} keymap={{ locale.keymap }}

- name: Copy the configuration file
  tags: preseed
  template:
    src: common.conf
    dest: '{{ build_dir }}/common.conf'

- name: Create the profile folder
  tags: preseed
  file:
    path: '{{ build_dir }}/profiles'
    state: directory

- name: Get the first disk size (used for lvm & raid)
  set_fact:
    dsize: '{{ system.hw.disks[0].size | regex_replace("[^0-9]", "") | int }}'
    disk_name: '{{ system.hw.disks[0].name }}'

- name: Copy the profile folder content
  tags: preseed
  template:
    src: 'profiles/{{ system.preseed }}/{{ file }}'
    dest: '{{ build_dir }}/profiles/{{ file }}'
  with_items:
    - default.description
    - default.packages
    - default.postinst
    - default.preseed
  loop_control:
    loop_var: file

- name: Copy the miscellaneous files that need to be on the CD/DVD image
  tags: preseed
  copy:
    src: '{{ playbook_dir }}/../misc'
    dest: '{{ build_dir }}'

- name: Build debian mirror
  shell: >-
    simple-cdd
    --verbose
    --debian-mirror {{ build_mirror }} --locale {{ build_locale }} --dist {{ build_dist }}
    --do-mirror --mirror-only --keyring /usr/share/keyrings/debian-archive-keyring.gpg
  args:
    chdir: '{{ build_dir }}'

- name: Create the etc directory to be deployed
  file:
    path: '{{ playbook_dir }}/../misc/etc'
    state: directory

- name: Add the environment file to be deployed
  template:
    src: environment.conf
    dest: '{{ playbook_dir }}/../misc/etc/environment'

- name: Create the miscellaneous files archive for the cd image
  shell: >-
    tar c -C "{{ playbook_dir }}/../misc" \
    --group=root --owner=root \
    -z -f "{{ build_dir }}/misc.tgz" .
  args:
    chdir: '{{ build_dir }}'
    warn: false

- name: Build the iso installer image
  shell: >-
    simple-cdd
    --debian-mirror {{ build_mirror }}
    --locale {{ build_locale }}
    --dist {{ build_dist }}
    --build-only
    --conf common.conf
    --logfile build.log
    --verbose
  args:
    chdir: '{{ build_dir }}'

- name: Copy the iso image if needed
  when: cdimage.destination
  shell: >-
    mv '{{ build_dir }}/images/debian-11-amd64-CD-1.iso'
    {{ cdimage.destination }}/homebox-{{ system.hostname }}-{{ system.preseed }}-installer.iso
  args:
    warn: false

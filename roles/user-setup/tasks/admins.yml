---

- name: Create the administrators list
  set_fact:
    administrators: '{{ users | selectattr("ssh_key", "defined") | list }}'

# These tasks are configuring the system to give access
# to some administrators, without having to logon as root.
# You need to define a public SSH key for each user.
# see example YAML file
- name: Add SSH keys for the administrators
  authorized_key:
    user: '{{ user.uid }}'
    key: >-
      {{ user.ssh_key.type }}
      {{ user.ssh_key.data | regex_replace(" ") }}
      {{ user.ssh_key.comment }}
    state: present
  loop: '{{ administrators }}'
  loop_control:
    loop_var: user

- name: Add the administrators to the sudo group
  user:
    name: '{{ user.uid }}'
    groups: sudo
    append: true
  loop: '{{ administrators }}'
  loop_control:
    loop_var: user

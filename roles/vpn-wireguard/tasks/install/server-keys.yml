---

- name: Generate private and public keys
  register: genkey_cmd
  shell: >-
    wg genkey | tee private-key
    | wg pubkey >public-key
  args:
    creates: /etc/wireguard/public-key
    chdir: /etc/wireguard

- name: Remember the private key just generated
  when: genkey_cmd.changed
  set_fact:
    private_key: '{{ genkey_cmd.stdout }}'

- name: Load the private key previously generated
  when: not genkey_cmd.changed
  block:
    - name: Dump private key
      register: dumpkey_cmd
      shell: cat /etc/wireguard/private-key
      changed_when: false
    - name: Remember the key
      set_fact:
        private_key: '{{ dumpkey_cmd.stdout }}'

- name: Ensure permissions are correct
  file:
    path: /etc/wireguard/private-key
    mode: '0600'

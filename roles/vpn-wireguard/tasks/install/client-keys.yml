---

- name: Create the user directory
  file:
    path: /home/users/{{ user.uid }}/vpn/default-keys/
    state: directory
    owner: '{{ user.uid }}'
    group: '{{ user.uid }}'
    mode: '0700'

- name: Create the key pair for this user
  register: genkey_cmd
  become: true
  become_user: '{{ user.uid }}'
  shell: >-
    wg genkey | tee private-key
    | wg pubkey > public-key
  args:
    chdir: /home/users/{{ user.uid }}/vpn/default-keys/
    creates: /home/users/{{ user.uid }}/vpn/default-keys/private-key

- name: Load the private key previously generated
  when: not genkey_cmd.changed
  block:
    - name: Dump public key
      register: dumpkey_cmd
      shell: cat /home/users/{{ user.uid }}/vpn/default-keys/public-key
      changed_when: false
    - name: Remember the key
      set_fact:
        public_key: '{{ dumpkey_cmd.stdout }}'

- name: Append the user key
  set_fact:
    user_keys: >-
      {{ user_keys | combine({ user.uid: dumpkey_cmd.stdout}) }}

- name: Set permissions to the file
  file:
    path: /home/users/{{ user.uid }}/vpn/default-keys/private-key
    mode: '0600'

---

- name: Create the directory to store data
  file:
    path: /var/lib/powerdns/
    state: directory
    owner: pdns
    group: pdns
    mode: 0700

- name: Initialise the database
  register: database
  become: true
  become_user: pdns
  shell: >-
    sqlite3 -init
    /usr/share/pdns-backend-sqlite3/schema/schema.sqlite3.sql
    default.db
  args:
    creates: /var/lib/powerdns/default.db
    chdir: /var/lib/powerdns/
  changed_when: true

- name: Set the right permissions
  notify: Restart PowerDNS
  file:
    path: /var/lib/powerdns/default.db
    owner: pdns
    group: pdns
    mode: 0644

- name: Create configuration subdir
  file:
    path: /etc/powerdns/pdns.d
    state: directory

- name: Create a custom api key
  set_fact:
    api_key: >-
      {{ lookup(creds.store, creds.prefix + "dns/api-key"
      + creds.opts.create + creds.opts.system)
      }}

- name: Set default SOA
  set_fact:
    default_soa: >-
      main.{{ network.domain }}.
      hostmaster.@ 0
      {{ dns.refresh }} {{ dns.retry }}
      {{ dns.expire }}
      {{ dns.ttl }}
    cacheable: yes

- name: Add custom settings
  notify: Restart PowerDNS
  template:
    src: pdns.conf
    dest: /etc/powerdns/pdns.d/homebox.conf
    owner: root
    group: pdns
    mode: 0640

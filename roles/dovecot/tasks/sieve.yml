---

- name: Create the global sieve directories
  tags: sieve
  file:
    path: '{{ dir.path }}'
    state: directory
    mode: '{{ dir.mode }}'
    owner: '{{ dir.owner }}'
    group: '{{ dir.group }}'
  loop:
    - path: /etc/dovecot/sieve
      mode: '0750'
      owner: root
      group: dovecot
    # The second folder need to be accessible by the users
    # as dovecot read the sieve scripts as the final user
    - path: /var/lib/dovecot/sieve
      owner: dovecot
      group: dovecot
      mode: '0755'
  loop_control:
    loop_var: dir

- name: Copy global sieve configuration
  tags: sieve
  notify: Restart dovecot
  template:
    src: 'sieve/{{ file }}'
    dest: '/etc/dovecot/sieve/{{ file }}'
    mode: '0640'
  with_items:
    - '{{ sieve.global_scripts }}'
  loop_control:
    loop_var: file

- name: Create global sieve scripts symbolic links in /var
  tags: dovecot
  file:
    src: '/etc/dovecot/sieve/{{ file }}'
    dest: '/var/lib/dovecot/sieve/{{ file }}'
    state: link
  with_items:
    - '{{ sieve.global_scripts }}'
  loop_control:
    loop_var: file

- name: Restart dovecot to reload sieve plugins
  tags: dovecot
  systemd:
    name: dovecot
    state: restarted

- name: Compile global sieve scripts
  tags: dovecot
  shell: >-
      /usr/bin/sievec
      /var/lib/dovecot/sieve/{{ file }}
      /var/lib/dovecot/sieve/{{ file | replace(".sieve", ".svbin") }}
  args:
    creates: '/var/lib/dovecot/sieve/{{ file | replace(".sieve", ".svbin") }}'
  with_items:
    - '{{ sieve.global_scripts }}'
  loop_control:
    loop_var: file

- name: Allow users to read the compiled sieve scripts
  tags: dovecot
  file:
    path: '/var/lib/dovecot/sieve/{{ file | replace(".sieve", ".svbin") }}'
    mode: '0644'
    owner: root
    group: root
  with_items:
    - '{{ sieve.global_scripts }}'
  loop_control:
    loop_var: file

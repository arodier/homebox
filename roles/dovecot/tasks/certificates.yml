---

# At this point, the certificates should have been created already #############
# in order to have SSL and TLS encryption activated.                           #

- name: Set the default permissions for the ldap certificate folders
  tags: cert
  import_role:
    name: cert-perms
  vars:
    cert_dir: 'ldap.{{ network.domain }}'
    entity_group: dovecot
    access_private_key: false

- name: Set the default permissions for the ldap certificate folders
  tags: cert
  import_role:
    name: cert-perms
  vars:
    cert_dir: 'imap.{{ network.domain }}'
    entity_group: dovecot
    access_private_key: false

- name: Set the default permissions for the ldap certificate folders
  when: mail.pop3
  tags: cert
  import_role:
    name: cert-perms
  vars:
    cert_dir: 'pop3.{{ network.domain }}'
    entity_group: dovecot
    access_private_key: false

- name: Copy the certificate renewal hook for the LDAP certificate access
  tags: scripts
  copy:
    src: renewal-hook.sh
    dest: /etc/letsencrypt/renewal-hooks/deploy/20-dovecot.sh
    mode: '0700'

- name: Copy the certificate renewal hook
  tags: cert
  copy:
    src: renew-cert.sh
    dest: /etc/letsencrypt/renewal-hooks/deploy/30-dovecot.sh
    mode: '0755'

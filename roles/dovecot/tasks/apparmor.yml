---

- name: Install some dovecot AppArmor profile
  tags: security, apparmor
  register: aa_templates
  template:
    src: 'apparmor.d/{{ aa_config }}.cf'
    dest: '/etc/apparmor.d/{{ aa_config }}'
  with_items: '{{ apparmor.profiles }}'
  loop_control:
    loop_var: aa_config

- name: Get the list of dovecot AppArmor profiles
  register: dovecot_apparmor_profiles
  find:
    paths: /etc/apparmor.d/
    patterns: '*dovecot*'

- name: Activate AppArmor profiles
  when: aa_templates.changed
  tags: dovecot, security, apparmor
  notify: Restart AppArmor service
  command: >-
    aa-{{ system.devel | ternary("complain", "enforce") }}
    {{ file.path | basename }}
  with_items:
    - '{{ dovecot_apparmor_profiles.files }}'
  loop_control:
    loop_var: file

- name: Install dovecot indexer AppArmor profile
  when: mail.fts.active
  tags: dovecot, security, apparmor
  register: aa_templates
  template:
    src: 'apparmor.d/{{ aa_config }}.cf'
    dest: '/etc/apparmor.d/{{ aa_config }}'
  with_items:
    - usr.lib.dovecot.indexer
    - usr.lib.dovecot.indexer-worker
    - usr.local.bin.decode2text
  loop_control:
    loop_var: aa_config

- name: Activate AppArmor profiles
  when: mail.fts.active and aa_templates.changed
  tags: dovecot, security, apparmor
  notify: Restart AppArmor service
  command: 'aa-enforce {{ aa_config }}'
  with_items:
    - usr.lib.dovecot.indexer
    - usr.lib.dovecot.indexer-worker
    - usr.local.bin.decode2text
  loop_control:
    loop_var: aa_config

---

- name: Check if the main sogo record exists
  register: main_sogo_record
  shell: >-
    dig -t {{ external_ip_type }}
    +nocomments +noall +answer
    sogo.{{ network.domain }} @127.0.0.1
  changed_when: false
  failed_when: false

- name: Store the fact for the main SOGO record
  set_fact:
    main_sogo_record_missing: '{{ main_sogo_record.stdout | length == 0 }}'

- name: Check if the backup sogo record exists
  when: backup_ip is defined
  register: backup_sogo_record
  shell: >-
    dig -t {{ backup_ip_type }}
    +nocomments +noall +answer
    sogo2.{{ network.domain }} @127.0.0.1
  changed_when: false
  failed_when: false

- name: Store the fact for the backup SOGO record
  when: backup_ip is defined
  set_fact:
    backup_sogo_record_missing: '{{ backup_sogo_record.stdout | length == 0 }}'

- name: Create the main SOGO record
  when: main_sogo_record_missing
  shell: >-
    pdnsutil add-record {{ network.domain }}
    sogo {{ external_ip_type }} {{ external_ip }}
  changed_when: true

- name: Create the backup SOGO record
  when: backup_ip is defined and backup_sogo_record_missing
  shell: >-
    pdnsutil add-record {{ network.domain }}
    sogo2 {{ backup_ip_type }} {{ backup_ip }}
  changed_when: true

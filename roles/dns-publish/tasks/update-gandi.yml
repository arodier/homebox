---

# Use Gandi’s API to publish DNSSEC records

- name: Load gandi’s api key
  no_log: '{{ not system.devel }}'
  set_fact:
    api_key: '{{ lookup(creds.store, network.domain + "/gandi/api-key") }}'

- name: List current DNSSEC
  delegate_to: localhost
  register: current_dnskeys
  uri:
    url: https://api.gandi.net/v5/domain/domains/{{ network.domain }}/dnskeys
    headers:
      authorization: 'Apikey {{ api_key }}'

- name: Show the current DNS keys
  debug:
    verbosity: 2
    var: current_dnskeys

- name: Filter the keys to publish
  set_fact:
    keys_list: '{{ keys_list | selectattr("type", "in", ["ksk", "zsk"]) | list }}'

- name: Store the keys in the filesystem
  register: published_keys
  copy:
    content: '{{ keys_list | to_nice_yaml }}'
    dest: /etc/powerdns/keys.yml

- name: Replace all the keys
  delegate_to: localhost
  when:
    - keys_list | length > 0
    - published_keys.changed
  uri:
    url: https://api.gandi.net/v5/domain/domains/{{ network.domain }}/dnskeys
    method: PUT
    body_format: json
    body:
      keys: '{{ keys_list }}'
    headers:
      authorization: 'Apikey {{ api_key }}'
    status_code: [ 200, 202 ]

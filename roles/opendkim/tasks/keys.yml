---

- name: Create directory to install the keys
  notify: Restart opendkim
  file:
    path: /etc/opendkim/keys
    state: directory
    owner: opendkim
    group: opendkim
    mode: 0700

- name: Use the current year for the selector
  set_fact:
    dkim_selector: 'main-{{ "%Y" | strftime }}'

- name: Run the command to create the keys
  notify: Restart opendkim
  register: keys
  command: >-
    opendkim-genkey
    --restrict
    --directory /etc/opendkim/keys
    --domain '{{ network.domain }}'
    --bits '{{ dkim.key_size }}'
    --selector='{{ dkim_selector }}'
    --note='{{ dkim.note | quote }}'
    {{ "--testmode" if system.devel else "" }}
  args:
    creates: '/etc/opendkim/keys/{{ dkim_selector }}.txt'

- name: Set the default permissions
  notify: Restart opendkim
  file:
    path: '{{ file.path }}'
    mode: '{{ file.mode }}'
    owner: opendkim
    group: opendkim
  loop:
    - path: '/etc/opendkim/keys/{{ dkim_selector }}.private'
      mode: '0600'
    - path: '/etc/opendkim/keys/{{ dkim_selector }}.txt'
      mode: '0640'
  loop_control:
    loop_var: file

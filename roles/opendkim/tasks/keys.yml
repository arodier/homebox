---

- name: Create directory to install the keys
  notify: Restart opendkim
  file:
    path: /etc/opendkim/keys
    state: directory
    owner: opendkim
    group: opendkim
    mode: 0700

- name: Run the command to create the keys
  notify: Restart opendkim
  register: keys
  command: >-
    opendkim-genkey
    --restrict
    -D /etc/opendkim/keys
    -d '{{ network.domain }}'
    -b '{{ dkim.key_size }}'
    -s '{{ dkim.selector }}'
    -n '{{ dkim.note }}'
  args:
    creates: '/etc/opendkim/keys/{{ dkim.selector }}.txt'

- name: Set the default permissions
  notify: Restart opendkim
  file:
    path: '{{ file.path }}'
    mode: '{{ file.mode }}'
    owner: opendkim
    group: opendkim
  loop:
    - path: '/etc/opendkim/keys/{{ dkim.selector }}.private'
      mode: '0600'
    - path: '/etc/opendkim/keys/{{ dkim.selector }}.txt'
      mode: '0640'
  loop_control:
    loop_var: file

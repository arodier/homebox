---

- name: Create the configuration file
  notify: Restart opendkim
  template:
    src: opendkim.conf
    dest: /etc/opendkim.conf

- name: Update the default configuration file for the socket
  notify: Restart opendkim
  replace:
    path: /etc/default/opendkim
    regexp: '^SOCKET.*'
    replace: 'SOCKET="inet:{{ dkim.milter.port }}@localhost"'

- name: Create the keys and signing table
  notify: Restart opendkim
  template:
    src: '{{ file }}'
    dest: '/etc/opendkim/{{ file }}'
  with_items:
    - keytable
    - signingtable
    - trusted-hosts
  loop_control:
    loop_var: file

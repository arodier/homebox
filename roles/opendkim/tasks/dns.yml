---

- name: Create a directory for DNS updates
  file:
    path: /etc/opendkim/dns
    state: directory

- name: Create the zone update file
  register: nsupdate_file
  shell: >-
    opendkim-genzone
    -d {{ network.domain }}
    -C hostmaster@{{ network.domain }}
    -F
    -M
    -u
    -T {{ dkim.validity }}
    {{ "-v" if system.devel or system.debug else "" }}
    -o nsupdate-{{ dkim_selector }}.conf
  args:
    chdir: /etc/opendkim/dns
    creates: nsupdate-{{ dkim_selector }}.conf

- name: Store the public key in DNS
  when: nsupdate_file.changed
  shell: >-
    nsupdate nsupdate-{{ dkim_selector }}.conf
  args:
    chdir: /etc/opendkim/dns
  changed_when: true

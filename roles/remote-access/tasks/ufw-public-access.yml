---

- name: Get the external IP address
  delegate_to: localhost
  register: ext_ip_api_response
  uri:
    url: https://api.ipify.org/
    return_content: true

- name: Make sure the external IP address is working as well
  tags: security
  ufw:
    proto: tcp
    port: 22
    src: '{{ ext_ip_api_response.content }}'
    rule: allow
    comment: Access SSH from the ansible host (IPv4)

# If IPv6 is disabled on the local machine,
# this task will fail, and we will just skip
# the next firewall update.
- name: Get the external IP address (IPv6)
  delegate_to: localhost
  register: ext_ip6_api_response
  uri:
    url: https://api64.ipify.org/
    return_content: true
  ignore_errors: true

# If IPv6 is enabled, but there is no public IPv6 address
# the IPv4 will be returned. The first test will ensure
# the IP address returned is a real IPv6.
- name: Make sure the external IP address is working as well
  when:
    - ext_ip6_api_response.content | ipv6
    - not ext_ip6_api_response.failed
  tags: security
  ufw:
    proto: tcp
    port: 22
    src: '{{ ext_ip6_api_response.content }}'
    rule: allow
    comment: Access SSH from the ansible host (IPv6)

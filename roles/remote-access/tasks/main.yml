---

- name: Remove ufw
  register: ufw_pkg
  apt:
    name: ufw
    state: absent
    purge: yes

- name: Install the nftable package
  register: nft_pkg
  apt:
    name: nftables
    state: present

- name: Restart nftables now
  when: nft_pkg.changed or ufw_pkg.changed
  systemd:
    name: nftables
    state: restarted

- name: Set the generic firewall rules
  include_tasks: generic-rules.yml

# The following tasks are run when the system is remote (e.g. cloud server)
- name: Store the remote IP address
  set_fact:
    remote_ip: '{{ hostvars[inventory_hostname]["ansible_default_ipv4"]["address"] }}'

- name: Check the type of IP address for the remote host
  set_fact:
    remote_ip_private: '{{ (remote_ip | ipaddr("private")) != None }}'

- name: Set the remote access firewall rules for public networks
  when: not remote_ip_private
  include_tasks: public-access.yml

# - name: Set the remote access firewall rules for private networks
#   when: system.devel and remote_ip_private
#   include_tasks: private-access.yml

- name: Configure the ssh server
  include_tasks: ssh-config.yml

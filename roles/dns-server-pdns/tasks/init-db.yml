---

- name: Create the zone if not exist
  register: zone_create_cmd
  shell: >-
    pdnsutil list-zone {{ network.domain }} ||
    pdnsutil create-zone {{ network.domain }}
  changed_when: >-
    "Creating empty zone" in zone_create_cmd.stderr

- name: Add the main external IP record
  when: zone_create_cmd.changed
  shell: >-
    pdnsutil add-record {{ network.domain }}
    main {{ external_ip_type }} {{ external_ip }}

- name: Add the backup external IP record
  when:
    - zone_create_cmd.changed
    - backup_ip is defined
  shell: >-
    pdnsutil add-record {{ network.domain }}
    backup {{ backup_ip_type }} {{ backup_ip }}

- name: Add the main external IP record
  when: zone_create_cmd.changed
  shell: >-
    pdnsutil add-record {{ network.domain }}
    @ {{ external_ip_type }} {{ external_ip }}

- name: Add the backup external IP record
  when:
    - zone_create_cmd.changed
    - backup_ip is defined
  shell: >-
    pdnsutil add-record {{ network.domain }}
    @ {{ backup_ip_type }} {{ backup_ip }}

- name: Add the main external record
  when: zone_create_cmd.changed
  shell: >-
    pdnsutil add-record {{ network.domain }}
    @ NS main.{{ network.domain }}

- name: Add the backup external record
  when:
    - zone_create_cmd.changed
    - backup_ip is defined
  shell: >-
    pdnsutil add-record {{ network.domain }}
    @ NS backup.{{ network.domain }}

# CAA records: https://en.wikipedia.org/wiki/DNS_Certification_Authority_Authorization
- name: Create CAA records
  when: zone_create_cmd.changed
  shell: >-
    pdnsutil add-record {{ network.domain }}
    '*' CAA
    '0 issue "letsencrypt.org"'

- name: Create CAA records
  when: zone_create_cmd.changed
  shell: >-
    pdnsutil add-record {{ network.domain }}
    '*' CAA
    '0 iodef "mailto:security@{{ network.domain }}"'

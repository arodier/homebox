---

- name: Copy password policies module loading into the changes directory
  register: ppolicy_module
  template:
    src: ppolicy-module.ldif
    dest: /etc/ldap/changes/ppolicy-module.ldif

- name: Load password policy module into the OLC database
  when: ppolicy_module.changed
  command: ldapmodify -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/ppolicy-module.ldif

- name: Copy the password policy schema into the changes directory
  register: ppolicy_schema
  copy:
    src: /etc/ldap/schema/ppolicy.ldif
    dest: /etc/ldap/changes/ppolicy-schema.ldif
    remote_src: true

- name: Activate password policies schema
  when: ppolicy_schema.changed
  command: ldapadd -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/ppolicy-schema.ldif

- name: Copy the overlay into the changes directory
  register: ldap_pwd_overlay
  template:
    src: overlay.ldif
    dest: /etc/ldap/changes/overlay.ldif

- name: Load the overlay definition
  when: ldap_pwd_overlay.changed
  command: ldapadd -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/overlay.ldif

- name: Create the password policies parent entry
  ldap_entry:
    bind_dn: '{{ ldap.admin.dn }}'
    bind_pw: '{{ admin_password }}'
    dn: 'ou=pwpolicies,{{ ldap.organization.base }}'
    objectClass:
      - organizationalUnit
      - top
    attributes:
      ou: pwpolicies
    state: present

- name: Create the default password policy
  ldap_entry:
    bind_dn: '{{ ldap.admin.dn }}'
    bind_pw: '{{ admin_password }}'
    dn: cn=default,ou=pwpolicies,{{ ldap.organization.base }}
    objectClass:
      - pwdPolicy
      - person
      - top
    attributes:
      cn: default
      sn: default
      pwdMaxAge: '{{ passwords.max_age }}'
      pwdInHistory: '{{ passwords.remember }}'
      pwdCheckQuality: '{{ passwords.quality.enforce | ternary(1,0) }}'
      pwdLockoutDuration: 0
      pwdGraceAuthNLimit: 0
      pwdFailureCountInterval: 300
      pwdMinLength: '{{ passwords.min_length }}'
      pwdAttribute: userPassword
      pwdMaxFailure: '{{ passwords.max_failure }}'
      pwdExpireWarning: '{{ passwords.expire_warning }}'

- name: Create the system account password policy
  ldap_entry:
    bind_dn: '{{ ldap.admin.dn }}'
    bind_pw: '{{ admin_password }}'
    dn: cn=system,ou=pwpolicies,{{ ldap.organization.base }}
    objectClass:
      - pwdPolicy
      - person
      - top
    attributes:
      cn: default
      sn: default
      pwdMaxAge: 0
      pwdInHistory: 0
      pwdCheckQuality: 0
      pwdLockoutDuration: 0
      pwdGraceAuthNLimit: 0
      pwdFailureCountInterval: 300
      pwdMinLength: 16
      pwdAttribute: userPassword

- name: Copy password hash overlay into the changes directory
  register: passwd_hash
  template:
    src: password-hash.ldif
    dest: /etc/ldap/changes/password-hash.ldif

- name: Load the password hash overlay
  when: passwd_hash.changed
  command: ldapmodify -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/password-hash.ldif

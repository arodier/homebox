---

- name: Copy the access policies on the server
  register: access_policies
  template:
    src: access-policies.ldif
    dest: /etc/ldap/changes/access-policies.ldif

- name: Load access policies
  when: access_policies.changed
  command: ldapadd -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/access-policies.ldif

- name: Copy index definitions on the server
  register: index_defs
  template:
    src: indexes.ldif
    dest: /etc/ldap/changes/indexes.ldif

- name: Add indexes to the database for optimisation
  when: index_defs.changed
  command: ldapmodify -QY EXTERNAL -H ldapi:/// -f /etc/ldap/changes/indexes.ldif

- name: Update the indexes
  when: index_defs.changed
  become: true
  become_user: openldap
  become_method: sudo
  command: 'slapindex -n 1 -v {{ field }}'
  with_items: '{{ indexed_fields }}'
  loop_control:
    loop_var: field

- name: Add local accounts to users groups
  ldap_attr:
    bind_dn: '{{ ldap.admin.dn }}'
    bind_pw: '{{ admin_password }}'
    dn: 'cn=mail_users,{{ ldap.groups.dn }}'
    name: memberUid
    values: '{{ user.uid }}'
    state: present
  with_items:
    - '{{ users }}'
  loop_control:
    loop_var: user

- name: Add system accounts to administrators groups
  ldap_attr:
    bind_dn: '{{ ldap.admin.dn }}'
    bind_pw: '{{ admin_password }}'
    dn: 'cn=administrators,{{ ldap.groups.dn }}'
    name: memberUid
    values: '{{ uid }}'
    state: present
  with_items:
    - manager
    - postmaster
  loop_control:
    loop_var: uid

- name: Install the nslcd package to map LDAP users to system users
  notify: Restart the ldap stack
  apt:
    name: nslcd
    state: present

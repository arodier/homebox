---

# Vultr is using a systemd service, with world wide write permissions:
# /var/lib/vultr/config/cloud-init-log-reader.service

# Vultr specific cleanup tasks
# The last wo files left are:
# - /etc/udev/rules.d/99-vultr-fix-virtio.rules
# - /usr/lib/sysctl.d/90-vultr.conf

- name: Disable the log reader service
  systemd:
    service: cloud-init-log-reader
    state: stopped
    enabled: false
    masked: true

- name: Remove vultr packages repository
  file:
    path: /etc/apt/sources.list.d/vultr-apprepo.list
    state: absent

- name: Remove Vultr apt key
  apt_key:
    id: 6EE69664B872D21326564A2ED4B17DEB5ECDB253
    state: absent

- name: Remove vultr lib folder
  file:
    path: /var/lib/vultr
    state: absent

- name: Remove /opt vultr folder
  file:
    path: /opt/vultr
    state: absent

- name: Remove cloud init log readers
  notify: Reload systemd
  file:
    path: '{{ path }}'
    state: absent
  loop:
    - /etc/systemd/system/cloud-init-log-reader.service
    - /etc/systemd/system/multi-user.target.wants/cloud-init-log-reader.service
  loop_control:
    loop_var: path

- name: Remove cloud-init package
  apt:
    name: cloud-init
    state: absent
    purge: true

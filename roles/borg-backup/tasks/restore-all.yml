---

- name: Deploy the services to restore the backup
  notify: Start restore services
  tags: restore
  template:
    src: backup-restore.systemd
    dest: /etc/systemd/system/backup-restore-{{ location.name }}.service
  loop: '{{ backup.locations }}'
  loop_control:
    loop_var: location

- name: Enable the services to restore backup
  notify: Start restore services
  systemd:
    name: backup-restore-{{ location.name }}
    enabled: '{{ location.restore | default(false) }}'
  loop: '{{ backup.locations }}'
  loop_control:
    loop_var: location

- name: Copy the SOGo restore script
  copy:
    src: sogo-restore.sh
    dest: /usr/local/sbin/sogo-restore.sh

- name: Install a dovecot index update cron job
  cron:
    cron_file: dovecot-indexes
    special_time: daily
    job: "doveadm -v index -q -A '*'"
    user: root

---

- name: Install the required file systems
  ansible.builtin.apt:
    name: 's3fs'
    state: present

- name: Create the S3 credentials file
  ansible.builtin.template:
    src: passwd-s3fs
    dest: '/etc/homebox/s3fs-{{ location.name }}'
    mode: '0600'

- name: Create the backup cache folder
  ansible.builtin.file:
    path: /home/.backup-cache/
    state: directory
    mode: '0700'

- name: Extract backup location details
  tags: backup, facts
  ansible.builtin.set_fact:
    protocol: '{{ location.url | urlsplit("scheme") }}'
    location_host: '{{ location.url | urlsplit("hostname") }}'
    location_user: '{{ location.url | urlsplit("username") | default("backup") }}'
    location_path: '{{ location.url | urlsplit("path") }}'
    location_details: '{{ location.url | urlsplit }}'

# Backup handling
- name: Add some patterns to exclude in the backups
  tags: backup
  ansible.builtin.lineinfile:
    path: /etc/homebox/backup-exclude
    line: '{{ line }}'
  with_items:
    - "# Exclude cache from backup"
    - 'pp:/home/.backup-cache/'
  loop_control:
    loop_var: line

- name: Create the backup config into /etc/homebox
  tags: config
  community.general.ini_file:
    path: '/etc/homebox/backup.ini'
    section: '{{ location.name }}'
    option: '{{ option.name }}'
    value: '{{ option.value }}'
    mode: '0600'
  with_items:
    - name: url
      value: '{{ location.url }}'
    - name: active
      value: '{{ location.active }}'
    - name: keep_daily
      value: '{{ location.keep_daily | default(1) }}'
    - name: keep_weekly
      value: '{{ location.keep_weekly | default(1) }}'
    - name: keep_monthly
      value: '{{ location.keep_monthly | default(1) }}'
    - name: compression
      value: '{{ location.compression | default("lz4") }}'
    - name: rate_limit
      value: '{{ location.rate_limit | default(0) }}'
  loop_control:
    loop_var: option

- name: Set mount options for s3fs
  ansible.builtin.set_fact:
    mount_options:
      - 'default_acl=private'
      - 'passwd_file=/etc/homebox/s3fs-{{ location.name }}'
      - 'use_cache=/home/.backup-cache/'
      - 'del_cache'

- name: Add region if specified
  when: >-
    "region" in location
  ansible.builtin.set_fact:
    mount_options:
      - 'endpoint={{ location.region }}'

- name: Add custom host if not using AWS
  when: >-
    "host" in location
  ansible.builtin.set_fact:
    mount_options: '{{ mount_options + [ "host=https://" + location.host ] }}'

- name: Add mount point definition for this device
  register: mount_systemd
  notify: Reload Systemd
  ansible.builtin.template:
    src: 'mount-s3fs.systemd'
    dest: '/etc/systemd/system/mnt-backup-{{ location.name }}.mount'
    mode: '0600'
  tags: systemd

- name: Add automount definition for this device
  notify: Reload Systemd
  ansible.builtin.template:
    src: mount-auto.systemd
    dest: '/etc/systemd/system/mnt-backup-{{ location.name }}.automount'
    mode: '0600'
  tags: systemd

- name: Enable the automount service
  notify: Reload Systemd
  ansible.builtin.systemd:
    name: 'mnt-backup-{{ location.name }}.automount'
    enabled: true
    state: started
  tags: systemd

- name: Enable the mount service
  notify: Reload Systemd
  ansible.builtin.systemd:
    name: 'mnt-backup-{{ location.name }}.mount'
    enabled: true
  tags: systemd

---

- name: Create the backup cache folder
  ansible.builtin.file:
    path: /home/.backup-cache/
    state: directory
    mode: '0700'

- name: Remove nftable rules
  notify: Restart nftables
  ansible.builtin.file:
    path: /etc/nftables/80-s3fs-{{ location.name }}.nft
    state: absent
  tags: nftables

- name: Stop the automount service
  ansible.builtin.systemd:
    name: 'mnt-backup-{{ location.name }}.automount'
    state: stopped
  tags: systemd

- name: Remove automount definition for this device
  notify: Reload Systemd
  ansible.builtin.file:
    path: '/etc/systemd/system/mnt-backup-{{ location.name }}.automount'
    state: absent
  tags: systemd

- name: Stop the mount service
  ansible.builtin.systemd:
    name: 'mnt-backup-{{ location.name }}.mount'
    state: stopped
  tags: systemd

- name: Remove mount point definition for this device
  notify: Reload Systemd
  ansible.builtin.file:
    path: '/etc/systemd/system/mnt-backup-{{ location.name }}.mount'
    state: absent
  tags: systemd

- name: Remove the S3 credentials file
  ansible.builtin.file:
    path: '/etc/homebox/s3fs-{{ location.name }}'
    state: absent

- name: Remove the required package
  ansible.builtin.apt:
    name: s3fs
    state: absent
    purge: true
    autoremove: true

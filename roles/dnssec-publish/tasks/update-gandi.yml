---

# Use Gandi’s API to publish DNSSEC records

- name: Load gandi’s api key
  no_log: '{{ not system.devel }}'
  set_fact:
    api_key: '{{ lookup(creds.store, network.domain + "/gandi/api-key") }}'

- name: List current DNSSEC
  delegate_to: localhost
  register: dnskeys
  uri:
    url: https://api.gandi.net/v5/domain/domains/{{ network.domain }}/dnskeys
    headers:
      authorization: 'Apikey {{ api_key }}'

- name: Store the keys
  set_fact:
    keys_list: '{{ keys_list | selectattr("type", "in", ["ksk", "zsk"]) | list }}'

# - name: Replace all the keys
#   when: keys_list | length > 0
#   delegate_to: localhost
#   uri:
#     url: https://api.gandi.net/v5/domain/domains/{{ network.domain }}/dnskeys
#     method: PUT
#     body_format: json
#     body:
#       keys: '{{ keys_list }}'
#     headers:
#       authorization: 'Apikey {{ api_key }}'
#     status_code: [ 200, 202 ]

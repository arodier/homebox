---

- name: Create the emails migration and import folders
  ansible.builtin.file:
    path: '{{ path }}'
    owner: '{{ user.uid }}'
    group: users
    state: directory
    mode: '0700'
  loop:
    - '/home/users/{{ user.uid }}/mails/import/safe'
    - '/home/users/{{ user.uid }}/mails/import/conf'
    - '/home/users/{{ user.uid }}/mails/import/logs'
    - '/home/users/{{ user.uid }}/mails/import/status'
  loop_control:
    loop_var: path

- name: Create a migration file for each account
  ansible.builtin.template:
    src: 'isync/{{ account.type }}.conf'
    dest: '/home/users/{{ user.uid }}/mails/import/conf/{{ account.name }}-{{ account.type }}.conf'
    owner: '{{ user.uid }}'
    group: users
    mode: '0600'
  loop: '{{ user.external_accounts | default([]) }}'
  loop_control:
    loop_var: account

- name: Encrypt each configuration file using the server's passphrase and place them in the safe
  ansible.builtin.command: >-
    openssl aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt
    -in /home/users/{{ user.uid }}/mails/import/conf/{{ account.name }}-{{ account.type }}.conf
    -out /home/users/{{ user.uid }}/mails/import/safe/{{ account.name }}-{{ account.type }}.conf
    -pass file:/etc/homebox/system-key
  changed_when: false
  loop: '{{ user.external_accounts | default([]) }}'
  loop_control:
    loop_var: account

- name: Change the owner to the user
  ansible.builtin.file:
    path: '/home/users/{{ user.uid }}/mails/import/safe/{{ account.name }}-{{ account.type }}.conf'
    owner: '{{ user.uid }}'
    group: users
    mode: '0600'
  loop: '{{ user.external_accounts | default([]) }}'
  loop_control:
    loop_var: account

- name: Remove the clear text version
  ansible.builtin.file:
    path: '/home/users/{{ user.uid }}/mails/import/conf/{{ account.name }}-{{ account.type }}.conf'
    state: absent
  loop: '{{ user.external_accounts | default([]) }}'
  loop_control:
    loop_var: account

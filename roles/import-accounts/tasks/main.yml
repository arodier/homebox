---

- name: Install isync package
  ansible.builtin.apt:
    name: '{{ mail_import_pkgs }}'
    state: present

# Get the import master account password
- name: Initialise the import user password parameters
  ansible.builtin.set_fact:
    import_password_params: "{{ backup_directory }}/ldap/import.pwd {{ policies.system.password }}"

- name: Create the import master user account password
  no_log: true
  ansible.builtin.set_fact:
    import_password: '{{ lookup("password", import_password_params) }}'

- name: Build a template for each account and each user, and encrypt it using the system key
  ansible.builtin.include_tasks: setup-user.yml
  with_items:
    - '{{ users | selectattr("external_accounts", "defined") | list }}'
  loop_control:
    loop_var: user

- name: Copy the postlogin scripts to start emails import on each user login
  notify: Restart dovecot
  tags: scripts
  ansible.builtin.copy:
    src: import-emails
    dest: /etc/dovecot/login-scripts/500-import-emails
    mode: '0755'
    owner: root
    group: root

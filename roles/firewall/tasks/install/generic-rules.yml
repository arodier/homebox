---

- name: Create the nftables directory
  ansible.builtin.file:
    path: /etc/nftables
    state: directory
  tags: rules

- name: Copy the main rules files
  notify: Restart nftables
  ansible.builtin.template:
    src: rules/{{ file.name }}.nft
    dest: /etc/nftables/{{ file.name }}.nft
    mode: 0600
  loop: '{{ rule_files | selectattr("include", "equalto", true) | list }}'
  loop_control:
    loop_var: file
  tags: rules

- name: Remove the excluded files
  notify: Restart nftables
  ansible.builtin.file:
    path: /etc/nftables/{{ file.name }}.nft
    state: absent
  loop: '{{ rule_files | selectattr("include", "equalto", false) | list }}'
  loop_control:
    loop_var: file
  tags: rules

- name: Copy the nftables parent configuration file
  notify: Restart nftables
  ansible.builtin.template:
    src: rules/main.nft
    dest: /etc/nftables.conf
    mode: 0600
  tags: rules

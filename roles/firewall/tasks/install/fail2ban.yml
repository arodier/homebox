---

- name: Install required package
  ansible.builtin.apt:
    name: '{{ f2b_packages }}'
  tags: f2b

- name: Set the verbose flag
  set_fact:
    verbose_flag: >-
      {{ system.devel or system.debug | ternary("-v", "") }}
  tags: f2b

- name: Install fail2ban helper script
  ansible.builtin.copy:
    src: fail2ban-nft-helper.sh
    dest: /usr/local/sbin/fail2ban-nft-helper
    mode: 0700
  tags: f2b, scripts

- name: Install fail2ban custom actions file
  notify: Restart fail2ban
  ansible.builtin.template:
    src: f2b/action-nftables.conf
    dest: /etc/fail2ban/action.d/nftables-multiport.conf
  tags: f2b

- name: Configure fail2ban to use nftables actions
  notify: Restart fail2ban
  ansible.builtin.replace:
    path: /etc/fail2ban/jail.conf
    regexp: '^banaction =.*'
    replace: 'banaction = nftables-multiport'
  tags: f2b

- name: Configure fail2ban to use nftables actions
  notify: Restart fail2ban
  ansible.builtin.replace:
    path: /etc/fail2ban/jail.conf
    regexp: '^banaction_allports =.*'
    replace: 'banaction_allports = nftables-multiport'
  tags: f2b

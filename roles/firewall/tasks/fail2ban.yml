---

- name: Stop fail2ban
  systemd:
    name: fail2ban
    state: stopped

- name: Install fail2ban helper script
  copy:
    src: fail2ban-helper.sh
    dest: /usr/local/sbin/fail2ban-helper
    mode: 0700

- name: Install fail2ban custom actions file
  template:
    src: f2b/action-nftables.conf
    dest: /etc/fail2ban/action.d/nftables-multiport.conf

- name: Configure fail2ban to use nftables actions
  notify: Restart fail2ban
  replace:
    path: /etc/fail2ban/jail.conf
    regexp: '^banaction =.*'
    replace: 'banaction = nftables-multiport'

- name: Configure fail2ban to use nftables actions
  notify: Restart fail2ban
  replace:
    path: /etc/fail2ban/jail.conf
    regexp: '^banaction_allports =.*'
    replace: 'banaction_allports = nftables-multiport'

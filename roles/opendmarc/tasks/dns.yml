---

- name: Create the directory
  file:
    path: /etc/opendmarc
    state: directory
    mode: 0700

- name: Initialise the dmarc record
  set_fact:
    dmarc_record: >-
      "v=DMARC1; p={{ dmarc.domain.policy }};"
      "sp={{ dmarc.domain.policy }};adkim={{ dmarc.dkim_align[0] }};"
      "rua=mailto:{{ dmarc.rua.email }}!{{ dmarc.rua.max_size }};"
      "ruf=mailto:{{ dmarc.ruf.email }}!{{ dmarc.ruf.max_size }};"
      "rf={{ dmarc.reporting.format }}; pct={{ dmarc.reporting.percent }};"
      "ri={{ dmarc.reporting.interval }}"
    cacheable: false

- name: Create the dns record template
  register: nsupdate_file
  template:
    src: nsupdate.conf
    dest: /etc/opendmarc/nsupdate.conf

- name: Store the public key in DNS
  when: nsupdate_file.changed
  shell: >-
    nsupdate nsupdate.conf
  args:
    chdir: /etc/opendmarc

---

- name: Create the lego directory to store the certificates
  file:
    path: /etc/lego
    state: directory
    mode: 0755
    owner: root
    group: root
  tags: preinstall

- name: Create the lego configuration directory
  file:
    path: /var/lib/lego
    state: directory
    mode: 0750
    group: ssl-cert
  tags: preinstall

- name: Create the directory to store certificates files
  file:
    path: /var/lib/lego/certificates
    state: directory
    mode: 0750
    group: ssl-cert
  tags: preinstall

- name: link for compatibility with lego executable
  file:
    src: /var/lib/lego/certificates
    dest: /etc/lego/certificates
    state: link
  tags: preinstall

- name: Get the DNS api key
  no_log: '{{ not system.devel }}'
  set_fact:
    api_key: '{{ lookup(creds.store, creds.prefix + "dns/api-key") }}'
  tags: preinstall

# LetsEncrypt will need to be accessed once the DNS server is live.
- name: Allow LetsEncrypt web site access in the proxy
  notify: Restart tinyproxy
  lineinfile:
    path: /etc/tinyproxy/filter
    line: '^acme-v02\.api\.letsencrypt\.org$'
  tags: preinstall, proxy

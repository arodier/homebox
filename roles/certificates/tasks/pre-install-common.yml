---

- name: Create the lego directory to store the certificates
  file:
    path: /etc/lego
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Create the lego configuration directory
  file:
    path: /var/lib/lego
    state: directory
    mode: 0750
    group: ssl-cert

- name: Create the directory to store certificates files
  file:
    path: /var/lib/lego/certificates
    state: directory
    mode: 0750
    group: ssl-cert

- name: link for compatibility with lego executable
  file:
    src: /var/lib/lego/certificates
    dest: /etc/lego/certificates
    state: link

- name: Get the DNS api key
  no_log: '{{ not system.devel }}'
  set_fact:
    api_key: '{{ lookup(creds.store, creds.prefix + "dns/api-key") }}'

- name: Store the API key for certificate renewal
  copy:
    content: '{{ api_key }}'
    dest: /etc/lego/dns-api-key
    mode: 0600
    owner: root
    group: root

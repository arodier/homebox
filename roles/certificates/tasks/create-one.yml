---

- name: Check if the certificate exists
  register: cert_file
  stat:
    path: /etc/lego/certificates/{{ certificate.name }}.{{ network.domain }}.crt

- name: Check if the certificate exists and is valid
  when: cert_file.stat.exists
  register: cert_check_cmd
  shell: >-
    openssl verify -verbose
    -CAfile {{ acme_root }}
    -untrusted /etc/lego/certificates/{{ certificate.name }}.{{ network.domain }}.issuer.crt
    /etc/lego/certificates/{{ certificate.name }}.{{ network.domain }}.crt
  ignore_errors: true
  changed_when: false

- name: Create the certificate
  when: >-
    not cert_file.stat.exists
    or cert_recreate
    or cert_check_cmd.failed
  environment:
    PDNS_API_URL: http://127.0.0.1:8081/
    PDNS_API_KEY: '{{ api_key }}'
    http_proxy: 'http://127.0.0.1:8888/'
    https_proxy: 'http://127.0.0.1:8888/'
  shell: >-
    lego
    --server {{ acme_url }}
    --key-type {{ certificate.type | default("rsa2048") }}
    --email security@{{ network.domain }}
    --dns pdns
    --accept-tos
    --path /etc/lego
    --domains {{ certificate.name }}.{{ network.domain }}
    {{ certificate.pem | bool | ternary("--pem", " ") }}
    run
  changed_when: true

---

- name: Create the certificate renewal configuration file
  template:
    src: renew.conf
    dest: /etc/lego/renew.conf
    mode: 0400
  tags: postinstall

- name: Copy the certificate renewal script
  copy:
    src: cert-renew.sh
    dest: /etc/cron.weekly/cert-renew
    mode: 0700
  tags: postinstall

- name: Copy the certificate status script
  copy:
    src: cert-status.sh
    dest: /usr/local/sbin/cert-status
    mode: 0755
  tags: postinstall

- name: Update system certificates to add LetsEncrypt staging CAs
  when: system.devel
  shell: update-ca-certificates
  changed_when: true
  tags: postinstall

- name: Modify SSL abstractions
  notify: Restart AppArmor
  lineinfile:
    path: /etc/apparmor.d/abstractions/ssl_certs
    line: '{{ line }}'
    state: present
  loop:
    - '  # lego certificates'
    - '  /var/lib/lego/certificates/*.crt r,'
  loop_control:
    loop_var: line
  tags: postinstall

- name: Modify SSL key abstractions
  notify: Restart AppArmor
  lineinfile:
    path: /etc/apparmor.d/abstractions/ssl_keys
    line: '{{ line }}'
    state: present
  loop:
    - '  # lego keys'
    - '  /var/lib/lego/certificates/*.key r,'
  loop_control:
    loop_var: line
  tags: postinstall

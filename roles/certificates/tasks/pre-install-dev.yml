---

- name: Use the staging Acme url
  set_fact:
    acme_url: https://acme-staging-v02.api.letsencrypt.org/directory

- name: Allow LetsEncrypt web site access in the proxy
  notify: Restart tinyproxy
  lineinfile:
    path: /etc/tinyproxy/filter
    line: acme-staging-v02.api.letsencrypt.org

- name: Create a directory to store the certificates
  file:
    path: /usr/local/share/ca-certificates/development/
    state: directory

- name: Download the staging root CAs for certificate verification
  environment:
    https_proxy: 'http://127.0.0.1:8888/'
  uri:
    url: https://letsencrypt.org/certs/staging/{{ cert_name }}.pem
    dest: /usr/local/share/ca-certificates/development/{{ cert_name }}.crt
    status_code: [ 200, 304 ]
  loop:
    - letsencrypt-stg-root-x1
    - letsencrypt-stg-root-x2
  loop_control:
    loop_var: cert_name

- name: Set the store for verification
  set_fact:
    acme_root: /usr/local/share/ca-certificates/development/letsencrypt-stg-root-x1.crt

---

# Some misconfigured servers are generating a lot of errors
# While this is happening before authentication, this generates
# a lot of noise and can be problematic to extract
# useful information from log files
- name: Add custom postfix fail2ban rule to reduce noise
  notify: Restart fail2ban
  file:
    path: /etc/fail2ban/filter.d/postfix-nr.conf
    state: absent

- name: Remove the section in the jail config
  notify: Restart fail2ban
  ini_file:
    path: /etc/fail2ban/jail.conf
    section: postfix-nr
    state: absent

- name: Disable fail2ban settings on postfix
  notify: Restart fail2ban
  ini_file:
    path: /etc/fail2ban/jail.conf
    section: '{{ section }}'
    option: enabled
    value: false
    create: no
  loop:
    - postfix
    - postfix-sasl
    - postfix-rbl
  loop_control:
    loop_var: section

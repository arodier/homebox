---

- name: Install tinyproxy for restricted http(s) access
  apt:
    name: tinyproxy
    state: present
  tags: proxy

- name: Deploy tinyproxy safe config
  notify: Restart tinyproxy
  template:
    src: tinyproxy.conf
    dest: /etc/tinyproxy/tinyproxy.conf
  tags: proxy

- name: Allow Debian repositories access
  notify: Restart tinyproxy
  lineinfile:
    path: /etc/tinyproxy/filter
    line: '{{ host }}'
    create: true
  loop: '{{ whitelisted_hosts }}'
  loop_control:
    loop_var: host
  tags: proxy

- name: Allow loopback access
  notify: Restart tinyproxy
  lineinfile:
    path: /etc/tinyproxy/filter
    line: '.{{ network.domain }}'
    create: true
  tags: proxy

- name: Restart the proxy now if needed
  meta: flush_handlers
  tags: proxy

- name: Now, ensure apt is using the system proxy
  template:
    src: proxy.conf
    dest: /etc/apt/apt.conf.d/00proxy
  tags: proxy

- name: Advertise the proxy as environment variables
  lineinfile:
    path: /etc/environment
    line: '{{ line }}'
  loop:
    - http_proxy=http://127.0.0.1:8888/
    - https_proxy=http://127.0.0.1:8888/
    - no_proxy=127.0.0.1,localhost,.{{ network.domain }},{{ network.domain }}
  loop_control:
    loop_var: line
  tags: proxy

- name: Set Systemd environment   # noqa 303
  shell: >-
    systemctl set-environment {{ line }}
  loop:
    - http_proxy=http://127.0.0.1:8888/
    - https_proxy=http://127.0.0.1:8888/
    - no_proxy=127.0.0.1,localhost,.{{ network.domain }},{{ network.domain }}
  loop_control:
    loop_var: line
  tags: proxy

---

- name: Install swaks to send package
  register: swaks_pkg
  apt:
    name: swaks
    state: present

- name: Create a unique subject and filename for testing
  set_fact:
    test_subject: 'Test email with virus {{ 1048576 | random | to_uuid }}'
    test_filename: '{{ 1048576 | random | to_uuid }}'

- name: Create an email template
  template:
    src: check/testmsg-01.txt
    dest: /tmp/testmsg-01.txt
    mode: 0600
    owner: clamav
    group: clamav

- name: Create an email template
  copy:
    src: check/clam.exe
    dest: /tmp/clam.exe
    mode: 0600
    owner: '{{ user0_uid }}'
    group: users

- name: Check if an email with a virus is rejected
  no_log: not system.devel
  shell: >-
    swaks
    --from="{{ users[0].mail }}"
    --to "{{ users[1].mail }}"
    --h-Subject '{{ test_subject }}'
    --attach /tmp/clam.exe
    --attach-name '{{ test_filename }}.exe'
    --attach-type application/exe
    -tls --tls-verify
    --auth
    --auth-user="{{ user0_uid }}"
    --auth-password="{{ user0_password }}"
    --server smtp.{{ network.domain }}
  become: yes
  become_method: sudo
  become_user: '{{ users[0].uid }}'

- name: Check if the email has been bounced
  when: mail.antivirus.action == 'bounce'
  register: email_bounced
  shell: >-
    grep -l -e '{{ test_subject }}'
    /home/users/{{ users[0].uid }}/mails/maildir/new/*
    | xargs grep -l 'Virus Detected'
  until: email_bounced.rc == 0
  retries: 30
  delay: 2

- name: Remove swaks package
  apt:
    name: swaks
    state: absent
    purge: true
    autoremove: true

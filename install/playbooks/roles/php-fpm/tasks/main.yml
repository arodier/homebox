---

- name: Get the current timezone
  register: timezone
  shell: cat /etc/timezone

- name: Install the required packages
  tags: apt
  apt:
    name: php-fpm
    state: present

- name: Add AppArmor profile
  notify: Restart php-fpm
  register: apparmor_php
  template:
    src: apparmor.cf
    dest: '/etc/apparmor.d/usr.sbin.php-fpm{{ php.version }}'

- name: Enforce AppArmor on php
  when: apparmor_php.changed
  shell: >-
    aa-enforce /etc/apparmor.d/usr.sbin.php-fpm{{ php.version }}

- name: Update PHP configuration
  notify: Restart php-fpm
  replace:
    path: '/etc/php/{{ php.version }}/fpm/php.ini'
    regexp: '{{ option.regexp }}'
    replace: '{{ option.replace }}'
  with_items:
    - regexp: '^;?date.timezone\s=.*'
      replace: 'date.timezone = {{ timezone.stdout }}'
  loop_control:
    loop_var: option
